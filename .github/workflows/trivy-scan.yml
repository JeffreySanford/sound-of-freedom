name: 'Trivy Scan'

on: [push, pull_request]

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build images that have Dockerfiles
        run: |
          set -e
          IMAGES=("apps/frontend" "apps/api" "apps/jen1" "apps/muscgen" "apps/orchestrator")
          BUILT_IMAGES=()
          for dir in "${IMAGES[@]}"; do
            dockerfile="$dir/Dockerfile"
            if [ -f "$dockerfile" ]; then
              tag="sound-creator-$(basename $dir):latest"
              echo "Building $tag from $dockerfile"
              docker build -t "$tag" -f "$dockerfile" .
              BUILT_IMAGES+=("$tag")
            else
              echo "No Dockerfile at $dockerfile, skipping build."
            fi
          done
          echo "Built images: ${BUILT_IMAGES[@]}"
          echo "BUILT_IMAGES=${BUILT_IMAGES[*]}" >> $GITHUB_ENV

      - name: Scan images with Trivy (container)
        run: |
          set -e
          IMAGES=( ${BUILT_IMAGES} )
          for image in "${IMAGES[@]}"; do
            echo "Scanning $image"
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image --format table --severity HIGH,CRITICAL --exit-code 1 "${image}" || true
          done

      - name: Generate and upload Trivy report files
        run: |
          set -e
          IMAGES=( ${BUILT_IMAGES} )
          for image in "${IMAGES[@]}"; do
            echo "Generating report for $image"
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image --format table --severity HIGH,CRITICAL --quiet "${image}" > "/tmp/$(echo ${image} | tr ':' '-')-trivy.txt" || true
          done
        continue-on-error: true

      - name: Upload Trivy reports
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: /tmp/*-trivy.txt
