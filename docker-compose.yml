services:
  frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
    image: sound-creator-frontend:latest
    ports:
      - "4200:4200"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4200/assets/health.html || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      - api
    environment:
      - API_URL=http://orchestrator:4000
    networks:
      - sc-net

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    image: sound-creator-api:latest
    ports:
      - "3000:3000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/__health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sc-net

  jen1:
    build:
      context: .
      dockerfile: apps/jen1/Dockerfile
    image: sound-creator-jen1:latest
    ports:
      - "4001:4001"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4001/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sc-net

  muscgen:
    build:
      context: .
      dockerfile: apps/muscgen/Dockerfile
    image: sound-creator-muscgen:latest
    ports:
      - "4002:4002"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4002/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sc-net

  redis:
    image: redis:7.2
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - sc-net

  ollama:
    build:
      context: .
      dockerfile: apps/ollama/Dockerfile
    image: sound-creator-ollama:latest
    # Host mapping can be overridden with environment variable OLLAMA_HOST_MAPPING.
    # Examples:
    #  - export OLLAMA_HOST_MAPPING=11434:11434  # host port 11434 -> container port 11434 (default)
    #  - export OLLAMA_HOST_MAPPING=11435:11434  # host port 11435 -> container port 11434
    #  - export OLLAMA_HOST_MAPPING=11434       # randomized host mapping for container port 11434
    ports:
      - "11434:11434"
    environment:
      - OLLAMA_LISTEN_PORT=11434
    networks:
      - sc-net

  orchestrator:
    build:
      context: .
      dockerfile: apps/orchestrator/Dockerfile
    image: sound-creator-orchestrator:latest
    ports:
      - "4000:4000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      - jen1
      - muscgen
      - redis
      - ollama
    environment:
      - JEN1_URL=http://jen1:4001/
      - MUSCGEN_URL=http://muscgen:4002/
      - REDIS_URL=redis://redis:6379
      - OLLAMA_URL=http://ollama:11434
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - sc-net

networks:
  sc-net:
    driver: bridge
